#!/bin/bash

# Pre-commit hook for lum-ui
# Generates component screenshots when source files change

set -e

# Check for force flag from environment variable
if [ "${FORCE_SCREENSHOTS}" = "1" ] || [ "${FORCE_SCREENSHOTS}" = "true" ]; then
  FORCE=true
else
  FORCE=false
fi

# Check if any component source files changed
if git rev-parse --verify HEAD >/dev/null 2>&1; then
  against=HEAD
else
  # Initial commit: diff against an empty tree object
  against=$(git hash-object -t tree /dev/null)
fi

changed_files=$(git diff --cached --name-only --diff-filter=ACM $against | grep -E '^src/(components|charts|tables|metrics|layouts)\.ts$' || true)

if [ -n "$changed_files" ] || [ "$FORCE" = true ]; then
  echo "üé® Regenerating component screenshots..."
  
  if [ "$FORCE" = true ]; then
    echo "üîÑ Force flag detected - regenerating all screenshots"
  else
    echo "üìù Changed component files:"
    echo "$changed_files" | sed 's/^/  - /'
  fi
  
  # Check if Chrome is installed
  if ! command -v google-chrome &> /dev/null && ! command -v chromium &> /dev/null && ! command -v chromium-browser &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: Chrome/Chromium not found. Skipping screenshot generation."
    echo "   Install Chrome: https://www.google.com/chrome/"
    echo "   Or Chromium: sudo apt-get install chromium-browser"
    exit 0
  fi
  
  # Set Puppeteer executable path
  if command -v google-chrome &> /dev/null; then
    export PUPPETEER_EXECUTABLE_PATH=$(command -v google-chrome)
  elif command -v chromium &> /dev/null; then
    export PUPPETEER_EXECUTABLE_PATH=$(command -v chromium)
  elif command -v chromium-browser &> /dev/null; then
    export PUPPETEER_EXECUTABLE_PATH=$(command -v chromium-browser)
  fi
  
  echo "üåê Using browser: $PUPPETEER_EXECUTABLE_PATH"
  
  # Generate screenshots
  if deno run --allow-all scripts/generate-screenshots.ts; then
    # Add generated screenshots to the commit
    if ls screenshots/*.png 1> /dev/null 2>&1; then
      git add screenshots/*.png
      echo "‚úÖ Screenshots generated and staged for commit"
    else
      echo "‚ö†Ô∏è  No screenshots were generated"
    fi
  else
    echo "‚ùå Screenshot generation failed"
    echo "   You can skip this with: git commit --no-verify"
    exit 1
  fi
else
  echo "‚úì No component source changes detected, skipping screenshot generation"
  echo "  Use: FORCE_SCREENSHOTS=1 git commit to force regeneration"
fi

exit 0
